pipeline {
    agent { label "TwoS" }
    environment{
        workDir = "D:\\addocs"
        rootDir = "D:\\ДЛЯ РЕЛИЗОВ\\work\\Данные конфигураций"
    }
    stages {
        stage('Подготовка .cf'){
            parallel{
                stage('Инициализация данных'){

                    if (params.STORAGE == 'Fitness'){
                        def env.base = "VAFitness"
                        def env.dir = "${env.rootDir}\\Фитнес клуб КОРП 4.0\\cf"
                    }
                    if (params.STORAGE == 'Salon'){
                        def base = "VASPA"
                        def env.dir = "${env.rootDir}\\SPA-Салон 3.0"
                    }
                    else{
                        def base = "VAStoma"
                        def env.dir = "${env.rootDir}\\1С_Стоматология 2.1\\CF"
                    }
                }
                stage('Выгрузка .cf из релизного'){

                    bat """
                    @call vrunner unload "${env.workDir}\\new\\${params.newversion}.cf" --ibconnection /Slocalhost/${env.base} --db-user Админ 
                    """
                }
                stage('Перенос .cf'){
                    
                    bat """
                    rmdir /S /Q "${env.workDir}"
                    mkdir "${env.workDir}\\new" "${env.workDir}\\old" "${env.workDir}\\xml_new" "${env.workDir}\\xml_old" 
                    move ${env.dir}\\${params.oldversion}.cf ${env.workDir}\\old
                    """

                }
            }
        }
        
        stage('Подключение и обновление из хранилища') {
            parallel {
                stage('Сравнение конфигураций') {
                    steps {
                        bat """
                        chcp 65001
                        @call vrunner compare --secondFile "${env.workDir}\\old\\${params.oldversion}.cf" --reportFile "${env.workDir}\\Отчет_${params.newversion}.txt" --reportType Brief --firstFile "${env.workDir}\\new\\${params.newversion}.cf" --ibconnection /Slocalhost/VAFitness --db-user Админ
                        """
                    }
                }
                stage('Выгрузка новой версии') {
                    steps {
                        bat """
                        chcp 65001
                        @call vrunner decompile --out ${env.workDir}\\xml_new --in "${env.workDir}\\new\\${params.newversion}.cf" --ibconnection /Slocalhost/VAFitness --db-user Админ --ibcmd
                        """
                    }
                }
                stage('Выгрузка старой версии') {
                    steps {
                        bat """
                        chcp 65001
                        @call vrunner decompile --out ${env.workDir}\\xml_old --in "${env.workDir}\\old\\${params.oldversion}.cf" --ibconnection /Slocalhost/VAFitness --db-user Админ --ibcmd
                        """
                    }
                }
            }
        }
    }
}
