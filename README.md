# ГРМ

**ГРМ** — сервис 1С, в который необходимо отправить файл `.dt`, полученный из пустой базы актуальной версии релиза.

- Отправка происходит после того, как 1С опубликовали релиз на портале.

## Файлы

Все файлы хранятся в папке `GRM`:

- **`Jenkinsfile`** — основной файл запуска всего процесса отправки в Jenkins.
- **`cleaning.py`** — удаляет содержимое папок `D:\dt` и `D:\cf`.
- **`transfer.py`** — копирует файл `.cf` из папки сборки релизов (`Old_versions_cf`).
- **`upload_file.py`** — выполняет PUT-запрос для отправки файла в ГРМ.

## Принцип работы

1. Удаляется содержимое папок `D:\dt` и `D:\cf`.
2. Получение ссылки предписания.
3. Файл `.cf` переносится из `Old_versions_cf` в `D:\cf`, загружается в пустую базу, обновляется конфигурация, затем выгружается `.dt` в папку `D:\dt`.
4. Файл `.dt` загружается в объектное хранилище.
5. Устанавливается версия по умолчанию.

## Запуск

**Процесс полностью автоматизирован**.

Запуск производится через **Jenkins**:  
**Сборки релизов → GRM → Собрать с параметрами**.
Агент выполнения (`OneS`) находится на 71 сервере.  

### Параметры запуска

- **`nameProduct`** — указывается в зависимости от продукта, который отправляем (`finessCorp`, `SpaSalon3`, `salon30`).
- **`version`** — устанавливаем версию в формате `x.x.xx.x`.
- **`jenkinsAgent`** — имя агента устанавливается по умолчанию (изменять не нужно).

---

# Сверка идентификаторов

**Сверка идентификаторов** — процесс выгрузки конфигурации в xml файлы, из рабочего и релизного хранилища.
После чего код проверяется на различие идентификаторов.

## Файлы

Все файлы хранятся в папке `IDENTIFICATOR`:

- **`c_jenkins`** — основной файл запуска Jenkins - **Стоматология**.
- **`f_jenkins`** — основной файл запуска Jenkins - **Фитнес**.
- **`s_jenkins`** — основной файл запуска Jenkins - **Салон**.
- **`telegram_file_sender.py`** — файл отправки сообщения с результами в виде картинки с результатми в **telegram**.
- **`configuration_comparison_manager.py`** — файл формирующий каритнку в формате excel с результатом сверки.

## Запуск

**Процесс полностью автоматизирован**.

Запуск производится через **Jenkins**:  
**Сверка идентификаторов** →

- **FITNESS**
- **SALON**
- **STOMA**

Агент выполнения (`master`) находится на 71 сервере.  

## Принцип работы

1. Подключение и обновление из хранилища.
2. Выгрузка `XML`.
3. Сверка конфигурации. Через расширение.
4. Отправка файла в чат.
5. Очистка каталога.

**Рабочие каталоги**

На 71 сервере `D:\Identificators` хранятися файлы для работы сверки идентификаторов.

- **`log`** — хранит логи в `xlsx` всех сборок и сгенерированную картинку которую отправит в telegram.
- **`Obarabotka`** — содержит обработку для сверки идентификаторов.
- **`Rab`** — в каталог выгружается база из рабочего хранилища.
- **`Relis`** — в каталог выгружается база из релизного хранилища.

# Автоматическое тестирование

Непрерывное тестирование продукта перед выпуском релиза

## Файлы

Все файлы хранятся в папке `tests`:

- **`Jenkinsfile`** — основной файл запуска Jenkins адаптирован под три продукта. `Фитнес клуб` `Салон красоты` `Стоматология`
- **tools/** — Группа файлов настроек
  - **VAParams.json** — настройки `Vanessa Automation`
- **scripts/** — Группа файлов подготовки и управления базой
  - **AgentRestart.py** — файл рестарта службы Агента сервера `1С`.
  - **drop_db.py** — файл удаления базы из кластера `1С` и `PostgresSQL`
  - **InitDatabase.bat** — файл запуска функций `vrunner`
- **notifications/** — `allure` отчет в `Telegram`
  - **allure-notifications-4.8.0.jar** — исполняющий файл.
  - **config.json** — настройки отчета `allure` и отправка сообщения в `Telegram`
  - **logo.png** — логотип продукта в отчете `allure`
- **features/** — Группы тестов
- **epf/** — обработки
- **cfe/** — расширения
- **build/** — результаты `allure` отчета

## Запуск

**Процесс полностью автоматизирован**.

Запуск производится через **Jenkins**:  

- **fitness**
- **salon**
- **stoma**

Агент выполнения (`OneS`) находится на 71 сервере.  

## Принцип работы

`Pipeline` выполняется автоматически в **`20:00`** по мск. В настройках `Pipeline` продукта который находится в тестировании необходимо включить `Запускать периодически` и указать время выполнения **`H 20 * * *`**

![VERSION_NEW][def3]

### 1. Подготовка базы

1. Удаление БД (если она существует)
2. Создание новой пустой базы
3. Загрузка .dt в новую базу
4. Обновление конфигурации базы данных
5. Загрузка данных из релизного хранилища
6. Обновление конфигурации базы данных

В случае ошибки какого либо из пунктов мы повторяем процедуру еще два раза. При последующей ошибке перезагружается агент севера 1С и повторяем процедуру подготовки базы еще два раза.

При успешном создании и заполненнии базы мы передаём параметр с версией релиза:

- Если версия релиза равна текущей версии в файле `D:\Vanessa-Automation\version`, то продолжаем выполнение `pipeline`
- Если версия релиза больше версии из файла, то мы запускаем процедуру выполнения обработчиков обновления и выгрузки/замены эталонной базы с новой версией

![VERSION_NEW][def2]

### 2. Сценарное тестирование

1. Отключение пользователей от базы данных
2. Выполнение тестов

### 3. Вывод allure отчета в Telegram

- Проверка резульатат тестирвоания, если стабильно или не стабильно отправляем отчет в `Telegram` в инном случае не отправляем.

### 4. Планируемые этапы

- Дымовые тесты
- syntax-check
- SonarQube

**Рабочие каталоги**

На 71 сервере `D:\Vanessa-Automation` хранятися файлы эталонных баз и версий.

![Этапы выполнения][def]

[def]: docs/build.jpg
[def2]: docs/pipeline.jpg
[def3]: docs/trigger.jpg

