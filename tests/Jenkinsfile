pipeline {
    agent {
        label "OneS"
    }
	environment {
        InitDatabase = "tests/scripts/InitDatabase.bat"
		dbTests = "AvtotestQA"
    }
    stages {
		stage("Подготовка и создание БД") {
			steps {
				script {
					def NAME_EPF = "ConnectedEquipment"
					def VA_EXTENSION = "VAExtension"
					def snakCase = "Наполнение"

					println "Начало обновления конфигурационного файла"
					updateConfigFile()

					// 1.0 Блокировка ИБ
					println "Блокировка информационной базы: ${params.dbName}"
					runDbOperation("session_lock", "\"${params.dbName}\"")

					// 1.1 Отключение пользователей
					println "Отключение пользователей от базы данных: ${params.dbName}"
					runDbOperation("session_kill", "\"${params.dbName}\"")

					// 1.2 Получение данных из релизного хранилища
					println "Загрузка данных из хранилища: ${params.repository} в базу: ${params.dbName}"
					runDbOperation("loadrepo", "\"${params.repository}\" \"${env.VATest}\" \"${params.dbName}\"")

					// 1.3 Обновление конфигурации БД
					println "Обновление конфигурации базы данных: ${params.dbName}"
					runDbOperation("updatedbRep", "\"${params.dbName}\"")

					// 1.4 Выгрузка .cf из релизного хранилища
					println "Выгрузка файла .cf из базы данных: ${params.dbName}"
					runDbOperation("unload", "\"${params.dbName}\"")

					// 1.5 Снятие блокировки сеансов
					println "Снятие блокировки сеансов для базы: ${params.dbName}"
					runDbOperation("session_unlock", "\"${params.dbName}\"")

					// 2.0 Создание пустой базы
					println "Создание новой пустой базы данных: ${env.dbTests}"
					runDbOperation("create", "\"${env.dbTests}\"")

					// 2.1 Установка расширения для разблокировки подключенного оборудования
					println "Установка расширения ${NAME_EPF} для базы: ${env.dbTests}"
					runDbOperation("run", "\"${env.WORKSPACE}\" \"${NAME_EPF}\" \"${env.dbTests}\"")

					// 2.2 Установка расширения VAExtension
					println "Установка расширения ${VA_EXTENSION} для базы: ${env.dbTests}"
					runDbOperation("run", "\"${env.WORKSPACE}\" \"${VA_EXTENSION}\" \"${env.dbTests}\"")

					// 2.3 Загрузка .cf в новую созданную базу
					println "Загрузка файла .cf в базу данных: ${env.dbTests}"
					runDbOperation("load", "\"${env.dbTests}\"")

					// 2.4 Обновление новой БД
					println "Обновление конфигурации новой базы данных: ${env.dbTests}"
					runDbOperation("updatedb", "\"${env.dbTests}\"")

					// 3.0 Блокировка ИБ
					println "Блокировка информационной базы: ${env.dbTests}"
					runDbOperation("session_lock", "\"${env.dbTests}\"")

					// 3.1 Отключение пользователей
					println "Отключение пользователей от базы данных: ${env.dbTests}"
					runDbOperation("session_kill", "\"${env.dbTests}\"")

					// 3.2 Первоначальное заполнение
					println "Выполнение первоначального заполнения для продукта: ${params.product}"
					runDbOperation("vanessa", "\"${env.WORKSPACE}\" \"${params.product}\" \"${env.pathvanessa}\"")

					// 3.3 Наполнение данными
					println "Наполнение базы данных данными: ${snakCase}"
					runDbOperation("vanessa", "\"${env.WORKSPACE}\" \"${snakCase}\" \"${env.pathvanessa}\"")

					// 3.4 Снятие блокировки сеансов
					println "Снятие блокировки сеансов для базы: ${env.dbTests}"
					runDbOperation("session_unlock", "\"${env.dbTests}\"")
				}
			}
		}
        stage('Сценарное тестирвоание') {
            steps {
                script {
					updateConfigFile()
					try	{
					// 4.0 Блокировка ИБ
					runDbOperation("session_lock", "\"${env.dbTests}\"")
					// 4.1 Отключение пользователей
					runDbOperation("session_kill", "\"${env.dbTests}\"")
					// 4.2 Сценарное тестирование
					runDbOperation("vanessaTest", "\"${env.WORKSPACE}\" \"${params.TestPathPlaceholder}\" \"${env.pathvanessa}\" \"${env.dbTests}\"")
					// 4.3 Снятие блокировки сеансов
					runDbOperation("session_unlock", "\"${env.dbTests}\"")
					// 4.4 Генерация Allure отчета
					runDbOperation("allure")

 					}catch(Exception Exc){
						currentBuild.result = 'UNSTABLE'
					}
                }
            }
        }
	}
	post {
		always {
			script {
				allure([
					includeProperties: false,
					jdk: '',
					results: [['path': 'tests/build/results']]
				])
				// Отправка уведомлений только при SUCCESS или UNSTABLE
				if (currentBuild.currentResult == "SUCCESS" || currentBuild.currentResult == "UNSTABLE") {
					if ("${params.dbName}" == "VAFitness") {
						env.logo = "tests/notifications/logo.png"
					}
					else if ("${params.dbName}" == "VASPA") {
						env.logo = "tests/notifications/logo1.png"
					}
					else if ("${params.dbName}" == "VAStoma") {
						env.logo = "tests/notifications/logo2.png"
					}

					def allureReportUrl = "${env.JENKINS_URL}job/${env.JOB_NAME.replaceAll('/', '/job/')}/${env.BUILD_NUMBER}/allure"
					def configJson = readFile(file: 'tests/notifications/config.json')
					def updatedConfigJson = configJson
						.replace('"${allureReportUrl}"', "\"${allureReportUrl}\"")
						.replace('"${JOB_NAME}"', "\"${env.JOB_NAME}\"")
						.replace('"${logo}"', "\"${env.logo}\"")
					writeFile(file: 'tests/notifications/config.json', text: updatedConfigJson)

					try {
						runDbOperation("notifications")
					}
					catch (Exception e) {
						echo "Ошибка при отправке уведомления: ${e.message}. Продолжаем выполнение pipeline."
					}
				}
			}
		}
	 }
}
def runDbOperation(operation, params) {
		try {
			bat """
				chcp 65001
				@call ${env.InitDatabase} ${operation} ${params}
			"""
		} catch (Exception e) {
			echo "Ошибка при выполнении операции ${operation}: ${e.message}"
			throw e
		}
	}

def updateConfigFile() {
    def configJson = readFile(file: 'tests/tools/VAParams.json')
    def updatedConfigJson = configJson.replaceAll(/\$\{product\}/, params.product)
    writeFile(file: 'tests/tools/VAParams.json', text: updatedConfigJson)
}
		// 1) Этап создание базы 
		// 2) Загрузка .cf из релизного
		// 3) Первоначальное заполнение
		// 4) Сценарное тестирование 
		// 5) Дымовые тесты
		// 6) Синтаксический контроль
		// 7) Сонар 
		// 8) Удаление базы